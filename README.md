# CozyTime BLE Bridge –¥–ª—è Home Assistant

ESPHome –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Ç–µ—Ä–º–æ–≥–∏–≥—Ä–æ–º–µ—Ç—Ä–∞ CozyTime —Å Home Assistant —á–µ—Ä–µ–∑ ESP32 BLE + MQTT.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. **–ó–∞–ø–æ–ª–Ω–∏—Ç–µ `secrets.yaml`** (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `secrets.yaml.example` –∫–∞–∫ —à–∞–±–ª–æ–Ω)
2. **–ü—Ä–æ—à–µ–π—Ç–µ ESP32:** `esphome run cozytime_bridge.yaml --device /dev/cu.usbserial-XXX`
3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ MQTT –≤ Home Assistant:** Settings ‚Üí Devices & Services ‚Üí Add MQTT
4. **–î–∞—Ç—á–∏–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** —á–µ—Ä–µ–∑ MQTT Discovery

**‚ö†Ô∏è –í–∞–∂–Ω–æ:** –ù–ï –¥–æ–±–∞–≤–ª—è–π—Ç–µ ESPHome –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤ Home Assistant! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ MQTT –¥–ª—è –¥–∞—Ç—á–∏–∫–æ–≤.

üìñ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** –°–º. [`HA_MQTT_CONFIG.md`](HA_MQTT_CONFIG.md)

---

## üìã –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –°—á–∏—Ç—ã–≤–∞–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (16-–±–∏—Ç, –≤—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å)
- ‚úÖ –°—á–∏—Ç—ã–≤–∞–Ω–∏–µ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ (%)
- ‚úÖ –°—á–∏—Ç—ã–≤–∞–Ω–∏–µ –∑–∞—Ä—è–¥–∞ –±–∞—Ç–∞—Ä–µ–∏ (%)
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏–ª—ã —Å–∏–≥–Ω–∞–ª–∞ (RSSI)
- ‚úÖ –î–æ—Å—Ç—É–ø –∫ —Å—ã—Ä—ã–º –¥–∞–Ω–Ω—ã–º BLE –ø–∞–∫–µ—Ç–∞ (hex)
- ‚úÖ Timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è –¥–∞—Ç—á–∏–∫–∞ (–º–µ—Å—è—Ü/–¥–µ–Ω—å/—á–∞—Å/–º–∏–Ω—É—Ç–∞)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π BLE –ø—Ä–æ—Ç–æ–∫–æ–ª
- ‚úÖ MQTT –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ–º (MQTT Discovery)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏ —Å Home Assistant

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
CozyTime –¥–∞—Ç—á–∏–∫ (BLE)
       ‚Üì
ESP32 (BLE —Å–∫–∞–Ω–µ—Ä + WiFi)
       ‚Üì
MQTT Broker (Mosquitto)
       ‚Üì
Home Assistant (MQTT –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **MQTT –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤** –∏ **Home Assistant API —Ç–æ–ª—å–∫–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** (OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞). –ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ ESPHome –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤ Home Assistant, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—á–∏–∫–æ–≤.

## üîß –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ**: ESP32 (–ª—é–±–∞—è –º–æ–¥–µ–ª—å —Å Bluetooth)
- **–ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ**: ESPHome 2023.x –∏–ª–∏ –Ω–æ–≤–µ–µ
- **Home Assistant**: –õ—é–±–∞—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
- **MQTT Broker**: Mosquitto –∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π MQTT –±—Ä–æ–∫–µ—Ä

## üì° –§–æ—Ä–º–∞—Ç BLE –ø–∞–∫–µ—Ç–∞ CozyTime

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ BLE Advertisement

```
BLE Advertisement Packet
‚îÇ
‚îú‚îÄ Manufacturer UUID:  0x51C9 (–Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ data)
‚îî‚îÄ Manufacturer Data:  [–º–∞—Å—Å–∏–≤ –±–∞–π—Ç–æ–≤ —Å –ø–æ–ª–µ–∑–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏]
```

### –ö–∞—Ä—Ç–∞ –±–∞–π—Ç–æ–≤ Manufacturer Data (14 –±–∞–π—Ç)

| –ë–∞–π—Ç | Hex –ø—Ä–∏–º–µ—Ä | Decimal | –û–ø–∏—Å–∞–Ω–∏–µ | –§–æ—Ä–º—É–ª–∞/–ó–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|---------|----------|------------------|
| `[0-3]` | `CE CD 6C CE` | - | **–ü—Ä–µ—Ñ–∏–∫—Å CozyTime** (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞) | –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ |
| `[4]` | `00` | 0 | –†–µ–∑–µ—Ä–≤ / –≤—Å–µ–≥–¥–∞ 0x00 | - |
| `[5]` | `9A` | 154 | **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (–º–ª–∞–¥—à–∏–π –±–∞–π—Ç)** | –°–º. —Ñ–æ—Ä–º—É–ª—É –Ω–∏–∂–µ ‚Üì |
| `[6]` | `02` | 2 | **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (—Å—Ç–∞—Ä—à–∏–π –±–∞–π—Ç)** | temp_value = (byte[6]<<8) \| byte[5] |
| `[7]` | `25` | 37 | **–í–ª–∞–∂–Ω–æ—Å—Ç—å** –≤ % | –ü—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 37% |
| `[8]` | `60` | 96 | **–ó–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏** –≤ % | –ü—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 96% |
| `[9]` | `01` | 1 | **Timestamp: —Ñ–ª–∞–≥** | –í—Å–µ–≥–¥–∞ 0x01 (–∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞) |
| `[10]` | `0C` | 12 | **Timestamp: –º–µ—Å—è—Ü** | 12 = –¥–µ–∫–∞–±—Ä—å (1-12) |
| `[11]` | `08` | 8 | **Timestamp: –¥–µ–Ω—å** | 8 = –≤–æ—Å—å–º–æ–µ —á–∏—Å–ª–æ (1-31) |
| `[12]` | `0D` | 13 | **Timestamp: —á–∞—Å** | 13 = 13:xx (0-23) |
| `[13]` | `01` | 1 | **Timestamp: –º–∏–Ω—É—Ç–∞** | 01 = xx:01 (0-59) |

### –§–æ—Ä–º—É–ª–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã

CozyTime –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∞—Ç—á–∏–∫ **[SHT40](docs/SHT40%20Datasheet.pdf)** (Sensirion) —Å –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–∞–ª–∏–±—Ä–æ–≤–∫–æ–π:

```cpp
// –®–∞–≥ 1: –°–æ–±–∏—Ä–∞–µ–º 16-–±–∏—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (Big-endian)
uint16_t temp_value = (byte[6] << 8) | byte[5];

// –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ–æ—Ä–º—É–ª—É
float temperature_F = 0.179987 * temp_value - 40.02;  // ¬∞F

// –î–ª—è –¶–µ–ª—å—Å–∏—è:
float temperature_C = (temperature_F - 32.0) * 5.0 / 9.0;
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –¢–æ—á–Ω–æ—Å—Ç—å: RMS = 0.064¬∞F (0.035¬∞C)
- –î–∏–∞–ø–∞–∑–æ–Ω: -40¬∞F –¥–æ 125¬∞F (-40¬∞C –¥–æ 52¬∞C)
- R¬≤ = 0.999995 (–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏–¥–µ–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è)
- –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –ø–æ 18 —Ç–æ—á–∫–∞–º

### –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞

```
CE CD 6C CE 00 9A 02 25 60 01 0C 08 0D 01
‚îÇ           ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ [13] –ú–∏–Ω—É—Ç–∞: 01
‚îÇ           ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ [12] –ß–∞—Å: 13 (13:01)
‚îÇ           ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [11] –î–µ–Ω—å: 08
‚îÇ           ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [10] –ú–µ—Å—è—Ü: 12 (–¥–µ–∫–∞–±—Ä—å)
‚îÇ           ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [9]  –§–ª–∞–≥: 01 (–∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞)
‚îÇ           ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [8]  –ë–∞—Ç–∞—Ä–µ—è: 96%
‚îÇ           ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [7]  –í–ª–∞–∂–Ω–æ—Å—Ç—å: 37%
‚îÇ           ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [6]  Temp Hi: 0x02 (2)
‚îÇ           ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [5]  Temp Lo: 0x9A (154)
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [4]  –†–µ–∑–µ—Ä–≤: 0x00
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [0-3] –ü—Ä–µ—Ñ–∏–∫—Å CozyTime

–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: temp_value = (2 << 8) | 154 = 666
             T = 0.179987 * 666 - 40.02 = 79.87¬∞F (‚âà26.6¬∞C)
–í—Ä–µ–º—è –∏–∑–º–µ—Ä–µ–Ω–∏—è: 08 –¥–µ–∫–∞–±—Ä—è, 13:01
```

### Timestamp –≤ –ø–∞–∫–µ—Ç–µ

–î–∞—Ç—á–∏–∫ **–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è** –≤ –ø–∞–∫–µ—Ç:
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ **~60 —Å–µ–∫—É–Ω–¥** (1 –º–∏–Ω—É—Ç–∞)
- –§–æ—Ä–º–∞—Ç: `[—Ñ–ª–∞–≥][–º–µ—Å—è—Ü][–¥–µ–Ω—å][—á–∞—Å][–º–∏–Ω—É—Ç–∞]`
- –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –≤—Ä–µ–º–µ–Ω–µ–º –ø–æ–ª—É—á–µ–Ω–∏—è (HA) –∏ –≤—Ä–µ–º–µ–Ω–µ–º –∏–∑–º–µ—Ä–µ–Ω–∏—è (BLE) ‚âà 7 –º–∏–Ω—É—Ç
- –≠—Ç–æ –∑–Ω–∞—á–∏—Ç –¥–∞—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É –∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç –∏—Ö –≤ —Ç–µ—á–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–∏—Ö ~7 –º–∏–Ω—É—Ç

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤

–°–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞:

```
cozytime_bridge/
‚îú‚îÄ‚îÄ cozytime_bridge.yaml    # –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ cozytime_parser.h        # –ü–∞—Ä—Å–µ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
‚îî‚îÄ‚îÄ secrets.yaml             # –°–µ–∫—Ä–µ—Ç—ã (WiFi –ø–∞—Ä–æ–ª–∏)
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ secrets.yaml

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `secrets.yaml.example` –≤ `secrets.yaml` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ:

```yaml
# API encryption key (—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–æ–º–∞–Ω–¥–æ–π: esphome wizard)
api_encryption_key: "YOUR_API_ENCRYPTION_KEY_HERE"

# WiFi credentials
wifi_ssid: "–≤–∞—à_wifi_ssid"
wifi_password: "–≤–∞—à_wifi_–ø–∞—Ä–æ–ª—å"
wifi_ap_password: "–ø–∞—Ä–æ–ª—å_—Ä–µ–∑–µ—Ä–≤–Ω–æ–π_—Ç–æ—á–∫–∏_–¥–æ—Å—Ç—É–ø–∞"

# OTA password
ota_password: "–ø–∞—Ä–æ–ª—å_–¥–ª—è_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π"

# MQTT credentials
mqtt_broker: "192.168.1.XXX"  # IP –≤–∞—à–µ–≥–æ MQTT –±—Ä–æ–∫–µ—Ä–∞
mqtt_port: "1883"
mqtt_username: "–≤–∞—à_mqtt_username"
mqtt_password: "–≤–∞—à_mqtt_–ø–∞—Ä–æ–ª—å"
```

### 3. –ü–µ—Ä–≤–∞—è –ø—Ä–æ—à–∏–≤–∫–∞ —á–µ—Ä–µ–∑ USB

–ù–∞–π–¥–∏—Ç–µ USB –ø–æ—Ä—Ç:
```bash
# macOS
ls /dev/cu.usbserial-* /dev/cu.wchusbserial* /dev/cu.SLAB_USBtoUART

# Linux
ls /dev/ttyUSB* /dev/ttyACM*
```

–ü—Ä–æ—à–µ–π—Ç–µ ESP32:
```bash
esphome run cozytime_bridge.yaml --device /dev/cu.usbserial-XXXXX
# –ó–∞–º–µ–Ω–∏—Ç–µ XXXXX –Ω–∞ –≤–∞—à –ø–æ—Ä—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: /dev/cu.usbserial-10)
```

### 4. –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WiFi (OTA)

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
esphome run cozytime_bridge.yaml

# –ò–ª–∏ —É–∫–∞–∑–∞—Ç—å IP —è–≤–Ω–æ
esphome run cozytime_bridge.yaml --device 192.168.1.XXX
```

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Home Assistant

–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **MQTT** –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Home Assistant.

#### –®–∞–≥ 1: –ü–æ–¥–∫–ª—é—á–∏—Ç–µ Home Assistant –∫ MQTT –±—Ä–æ–∫–µ—Ä—É

1. –û—Ç–∫—Ä–æ–π—Ç–µ **Settings** ‚Üí **Devices & Services**
2. –ù–∞–∂–º–∏—Ç–µ **+ Add Integration**
3. –ù–∞–π–¥–∏—Ç–µ **MQTT**
4. –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–∞—à–µ–≥–æ `secrets.yaml`:
   - **Broker:** IP –≤–∞—à–µ–≥–æ MQTT –±—Ä–æ–∫–µ—Ä–∞
   - **Port:** 1883
   - **Username:** –≤–∞—à mqtt_username
   - **Password:** –≤–∞—à mqtt_password
5. –ù–∞–∂–º–∏—Ç–µ **Submit**

#### –®–∞–≥ 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–æ–≤

–ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MQTT –±—Ä–æ–∫–µ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—Å—è** –≤ Home Assistant –±–ª–∞–≥–æ–¥–∞—Ä—è MQTT Discovery.

–î–∞—Ç—á–∏–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –≤:
- **Settings** ‚Üí **Devices & Services** ‚Üí **MQTT**
- –ù–∞–π–¥–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ **"CozyTime Bridge"**

#### ‚ö†Ô∏è –í–∞–∂–Ω–æ: –ò–∑–±–µ–≥–∞–π—Ç–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—á–∏–∫–æ–≤

**–ù–ï –¥–æ–±–∞–≤–ª—è–π—Ç–µ ESPHome –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é** –≤ Home Assistant!

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- ‚úÖ **MQTT** - –¥–ª—è –¥–∞—Ç—á–∏–∫–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–±)
- ‚úÖ **Home Assistant API** - —Ç–æ–ª—å–∫–æ –¥–ª—è OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

–ï—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å ESPHome –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é, –¥–∞—Ç—á–∏–∫–∏ –±—É–¥—É—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è.

#### –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–º. —Ñ–∞–π–ª [`HA_MQTT_CONFIG.md`](HA_MQTT_CONFIG.md) –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MQTT –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.

## üìä –°–µ–Ω—Å–æ—Ä—ã –≤ Home Assistant

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MQTT –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ Home Assistant –ø–æ—è–≤—è—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–Ω—Å–æ—Ä—ã:

| Entity ID | –ù–∞–∑–≤–∞–Ω–∏–µ | –ï–¥–∏–Ω–∏—Ü–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|---------|----------|
| `sensor.cozytime_bridge_cozytime_temperature` | CozyTime Temperature | ¬∞F | –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ –§–∞—Ä–µ–Ω–≥–µ–π—Ç–∞—Ö |
| `sensor.cozytime_bridge_cozytime_humidity` | CozyTime Humidity | % | –í–ª–∞–∂–Ω–æ—Å—Ç—å |
| `sensor.cozytime_bridge_cozytime_battery` | CozyTime Battery | % | –ó–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏ |
| `sensor.cozytime_bridge_cozytime_rssi` | CozyTime RSSI | dBm | –°–∏–ª–∞ BLE —Å–∏–≥–Ω–∞–ª–∞ |
| `sensor.cozytime_bridge_cozytime_temperature_raw` | CozyTime Temperature RAW | - | –°—ã—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ temp_value |
| `text_sensor.cozytime_bridge_cozytime_raw_packet` | CozyTime RAW Packet | - | –ü–æ–ª–Ω—ã–π BLE –ø–∞–∫–µ—Ç –≤ hex |
| `binary_sensor.cozytime_bridge_status` | CozyTime Bridge Status | - | –°—Ç–∞—Ç—É—Å ESP32 (Online/Offline) |

### üì° MQTT —Ç–æ–ø–∏–∫–∏

–î–∞–Ω–Ω—ã–µ —Ç–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ MQTT:

| –¢–æ–ø–∏–∫ | –î–∞–Ω–Ω—ã–µ | –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |
|-------|--------|-------------------|
| `cozytime_bridge/status` | `online`/`offline` | –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏/–æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ |
| `cozytime_bridge/temperature` | `79.8` (¬∞F) | –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ |
| `cozytime_bridge/humidity` | `37` (%) | –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ |
| `cozytime_bridge/battery` | `96` (%) | –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ |
| `cozytime_bridge/rssi` | `-65` (dBm) | –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ |

**–ü—Ä–æ–≤–µ—Ä–∫–∞ MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:**
```bash
# –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –≤—Å–µ —Ç–æ–ø–∏–∫–∏ CozyTime
mosquitto_sub -h BROKER_IP -p 1883 -u USERNAME -P PASSWORD -t "cozytime_bridge/#" -v
```

## üî¨ –§–æ—Ä–º—É–ª—ã –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è

### –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞

```cpp
// –®–∞–≥ 1: –°–æ–±–∏—Ä–∞–µ–º 16-–±–∏—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (Big-endian)
uint16_t temp_value = (byte[6] << 8) | byte[5];

// –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ–æ—Ä–º—É–ª—É
float temperature = 0.179987 * temp_value - 40.02;  // ¬∞F
```

**–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞:**
- –ü–æ–ª—É—á–µ–Ω–∞ –º–µ—Ç–æ–¥–æ–º –ª–∏–Ω–µ–π–Ω–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ –ø–æ **18 —Ç–æ—á–∫–∞–º** (-40¬∞F –¥–æ 91.2¬∞F)
- –¢–æ—á–Ω–æ—Å—Ç—å: **RMS = 0.064¬∞F** (0.035¬∞C)
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: **0.15¬∞F** (0.08¬∞C)
- R¬≤ = **0.999995** (–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏–¥–µ–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –î–∞—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **SHT40/SHT60** –æ—Ç Sensirion
- –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ –≤—Å–µ–º—É –¥–∏–∞–ø–∞–∑–æ–Ω—É: –æ—Ç –º–æ—Ä–æ–∑–Ω–æ–π —É–ª–∏—Ü—ã –¥–æ –≥–æ—Ä—è—á–µ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è
- –î–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ ¬∞C –≤ Home Assistant: Settings ‚Üí Devices ‚Üí Entity ‚Üí Unit of Measurement

**–ü—Ä–∏–º–µ—Ä:**
- `byte[5]=0x9A, byte[6]=0x02` ‚Üí `temp_value = (2<<8)|154 = 666`
- `T = 0.179987 √ó 666 - 40.02 = 79.87¬∞F` ‚Üí `‚âà26.6¬∞C`

### –í–ª–∞–∂–Ω–æ—Å—Ç—å

```cpp
float humidity = humid_byte;  // –ü—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±–µ–∑ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
- –î–∏–∞–ø–∞–∑–æ–Ω: 0-100%

### –ë–∞—Ç–∞—Ä–µ—è

```cpp
int battery = battery_byte;  // –ü—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±–µ–∑ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
- –î–∏–∞–ø–∞–∑–æ–Ω: 0-100%

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ BLE —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

–í —Ñ–∞–π–ª–µ `cozytime_bridge.yaml`:

```yaml
esp32_ble_tracker:
  scan_parameters:
    interval: 5s       # –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏
    window: 1.1s       # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–∫–Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    active: true       # –ê–∫—Ç–∏–≤–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- `interval: 5s` - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —á–∞—Å—Ç–æ—Ç–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —ç–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ–º
- `window: 1.1s` - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–∞
- –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∑–∞–≤–∏—Å–∞–Ω–∏—é ESP32

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –¥–∞—Ç—á–∏–∫–∏ –≤ Home Assistant

**–ü—Ä–∏—á–∏–Ω–∞:** –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è ESPHome –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ MQTT

**–†–µ—à–µ–Ω–∏–µ:**
1. –í Home Assistant –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Settings** ‚Üí **Devices & Services**
2. –ù–∞–π–¥–∏—Ç–µ **ESPHome** –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
3. –£–¥–∞–ª–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ **cozytime-bridge** (—Ç—Ä–∏ —Ç–æ—á–∫–∏ ‚Üí Delete)
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ MQTT –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–∞—Ç—á–∏–∫–æ–≤

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** Home Assistant API –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ESP32 –æ—Å—Ç–∞–≤—å—Ç–µ –≤–∫–ª—é—á–µ–Ω–Ω—ã–º - –æ–Ω –Ω—É–∂–µ–Ω –¥–ª—è OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏, –Ω–æ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –¥–∞—Ç—á–∏–∫–∏.

### MQTT –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–µ –∫—Ä–µ–¥–µ–Ω—à–∞–ª—ã –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –±—Ä–æ–∫–µ—Ä

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±—Ä–æ–∫–µ—Ä–∞:
   ```bash
   ping BROKER_IP
   ```
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ ESP32:
   ```bash
   esphome logs cozytime_bridge.yaml
   ```
   –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å: `[INFO] MQTT Connected!`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫—Ä–µ–¥–µ–Ω—à–∞–ª—ã –≤ `secrets.yaml`
4. –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±—Ä–æ–∫–µ—Ä—É:
   ```bash
   mosquitto_sub -h BROKER_IP -p 1883 -u USERNAME -P PASSWORD -t "test" -v
   ```

### –î–∞—Ç—á–∏–∫–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ Home Assistant

**–ü—Ä–∏—á–∏–Ω–∞:** MQTT Discovery –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–ª–∏ HA –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –±—Ä–æ–∫–µ—Ä—É

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ MQTT –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –≤ Home Assistant
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `discovery: true` –≤ `cozytime_bridge.yaml`
3. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ discovery —Å–æ–æ–±—â–µ–Ω–∏—è:
   ```bash
   mosquitto_sub -h BROKER_IP -p 1883 -u USERNAME -P PASSWORD \
     -t "homeassistant/#" -v
   ```
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Home Assistant

### ESP32 –∑–∞–≤–∏—Å–∞–µ—Ç / –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –°–ª–∏—à–∫–æ–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ BLE —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∏–∑–±—ã—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ:**
```yaml
logger:
  level: WARN  # –°–Ω–∏–∑–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

esp32_ble_tracker:
  scan_parameters:
    interval: 10s  # –£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª
```

### –°–µ–Ω—Å–æ—Ä—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç 0.0 –∏–ª–∏ "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ"

**–ü—Ä–∏—á–∏–Ω–∞:** CozyTime –¥–∞—Ç—á–∏–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–∞—Ç—á–∏–∫ –≤–∫–ª—é—á–µ–Ω –∏ —Ä—è–¥–æ–º —Å ESP32
2. –í–∫–ª—é—á–∏—Ç–µ debug –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ:
   ```yaml
   logger:
     level: DEBUG
   esp32_ble_tracker:
     log_level: DEBUG
   ```
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `CE CD 6C CE`

### OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω–∞:** ESP32 –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ —Å–µ—Ç–∏

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ ESP32 –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ WiFi
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å ESP32
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ USB –¥–ª—è –ø—Ä–æ—à–∏–≤–∫–∏

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

```bash
esphome logs cozytime_bridge.yaml
```

### –ü–æ–ª–µ–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```yaml
logger:
  level: DEBUG  # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–º–Ω–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)
  level: INFO   # –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
  level: WARN   # –ú–∏–Ω–∏–º—É–º –ª–æ–≥–æ–≤ (—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å)
```

## üìÑ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
cozytime_bridge/
‚îú‚îÄ‚îÄ cozytime_bridge.yaml      # –ì–ª–∞–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ESPHome
‚îú‚îÄ‚îÄ cozytime_parser.h          # Custom –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (legacy, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
‚îú‚îÄ‚îÄ secrets.yaml               # –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (WiFi, MQTT)
‚îú‚îÄ‚îÄ secrets.yaml.example       # –®–∞–±–ª–æ–Ω –¥–ª—è secrets.yaml
‚îú‚îÄ‚îÄ README.md                  # –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ HA_MQTT_CONFIG.md          # –î–µ—Ç–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Home Assistant + MQTT
‚îú‚îÄ‚îÄ MQTT_SETUP.md              # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MQTT –±—Ä–æ–∫–µ—Ä–∞
‚îú‚îÄ‚îÄ MQTT_QUICKSTART.md         # –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç —Å MQTT
‚îú‚îÄ‚îÄ PROTOCOL_ANALYSIS.md       # –ê–Ω–∞–ª–∏–∑ BLE –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ CozyTime
‚îú‚îÄ‚îÄ PROJECT_STRUCTURE.md       # –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ SECURITY_AUDIT.md          # –û—Ç—á–µ—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ .gitignore                 # –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è git
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ README.md              # –°–ø—Ä–∞–≤–∫–∞ –ø–æ –¥–∞—Ç—á–∏–∫—É SHT40
‚îÇ   ‚îî‚îÄ‚îÄ SHT40 Datasheet.pdf    # –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π datasheet
‚îú‚îÄ‚îÄ helpers/
‚îÇ   ‚îú‚îÄ‚îÄ check_formula.py       # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—É–ª—ã —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
‚îÇ   ‚îî‚îÄ‚îÄ analyze_timestamp.py   # –ê–Ω–∞–ª–∏–∑ timestamp –≤ –ø–∞–∫–µ—Ç–∞—Ö
‚îî‚îÄ‚îÄ stats/
    ‚îú‚îÄ‚îÄ data.csv               # –ö–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (18 —Ç–æ—á–µ–∫)
    ‚îî‚îÄ‚îÄ history.csv            # –ò—Å—Ç–æ—Ä–∏—è BLE –ø–∞–∫–µ—Ç–æ–≤
```

## üéØ –ü—Ä–∏–º–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–π –≤ Home Assistant

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∏–∑–∫–æ–º –∑–∞—Ä—è–¥–µ –±–∞—Ç–∞—Ä–µ–∏

```yaml
automation:
  - alias: "CozyTime Low Battery Alert"
    trigger:
      - platform: numeric_state
        entity_id: sensor.cozytime_bridge_cozytime_battery
        below: 20
    action:
      - service: notify.mobile_app
        data:
          message: "CozyTime battery is low: {{ states('sensor.cozytime_bridge_cozytime_battery') }}%"
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ ESP32

```yaml
automation:
  - alias: "CozyTime Bridge Offline"
    trigger:
      - platform: state
        entity_id: binary_sensor.cozytime_bridge_status
        to: 'off'
        for: '00:05:00'  # 5 –º–∏–Ω—É—Ç –æ—Ñ–ª–∞–π–Ω
    action:
      - service: notify.mobile_app
        data:
          title: "‚ö†Ô∏è CozyTime Bridge Offline"
          message: "ESP32 bridge is not responding. Check power and WiFi."
```

### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ Lovelace Card

```yaml
type: entities
title: CozyTime Sensor
entities:
  - entity: sensor.cozytime_bridge_cozytime_temperature
    name: Temperature
  - entity: sensor.cozytime_bridge_cozytime_humidity
    name: Humidity
  - entity: sensor.cozytime_bridge_cozytime_battery
    name: Battery
  - entity: sensor.cozytime_bridge_cozytime_rssi
    name: Signal Strength
  - entity: binary_sensor.cozytime_bridge_status
    name: ESP32 Status
```

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [ESPHome Documentation](https://esphome.io/)
- [ESP32 BLE Tracker](https://esphome.io/components/esp32_ble_tracker.html)
- [ESPHome MQTT Component](https://esphome.io/components/mqtt.html)
- [Home Assistant](https://www.home-assistant.io/)
- [Home Assistant MQTT Integration](https://www.home-assistant.io/integrations/mqtt/)
- [Mosquitto MQTT Broker](https://mosquitto.org/)
- [SHT40 Datasheet](docs/SHT40%20Datasheet.pdf) - –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–∞—Ç—á–∏–∫–∞ Sensirion

## üìú –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License - —Å–≤–æ–±–æ–¥–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è –ª–∏—á–Ω—ã—Ö –∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö —Ü–µ–ª–µ–π.

## üôè –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏

–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Ä–µ–≤–µ—Ä—Å-–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ CozyTime BLE —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.

---

**–í–µ—Ä—Å–∏—è:** 2.1
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 10 –¥–µ–∫–∞–±—Ä—è 2025
**–ê–≤—Ç–æ—Ä:** @andreyorlov

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ v2.1:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è MQTT –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ MQTT Discovery –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –≤ Home Assistant
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ (`HA_MQTT_CONFIG.md`)
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—á–∏–∫–æ–≤
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ Home Assistant API
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ MQTT –∫–æ–º–∞–Ω–¥

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ v2.0:**
- ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω BLE –ø—Ä–æ—Ç–æ–∫–æ–ª (14 –±–∞–π—Ç)
- ‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω timestamp –≤ –ø–∞–∫–µ—Ç–µ (–±–∞–π—Ç—ã 9-13)
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (18 —Ç–æ—á–µ–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏, -40¬∞F –¥–æ 91.2¬∞F)
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω –¥–∞—Ç—á–∏–∫: SHT40/SHT60 –æ—Ç Sensirion
- ‚úÖ –¢–æ—á–Ω–æ—Å—Ç—å: RMS = 0.064¬∞F (0.035¬∞C)
