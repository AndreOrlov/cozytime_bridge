# Changelog - CozyTime Bridge

## v2.2 - 10 –¥–µ–∫–∞–±—Ä—è 2025

### üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** ESP32 –∑–∞–≤–∏—Å–∞–ª –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—ã ESPHome Dashboard, –ø–µ—Ä–µ—Å—Ç–∞–≤–∞–ª –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ ping.

**–†–µ—à–µ–Ω–∏–µ:**
1. ‚úÖ **–û—Ç–∫–ª—é—á–µ–Ω captive_portal** - –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å BLE —Å–∫–∞–Ω–µ—Ä–æ–º
2. ‚úÖ **–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Arduino framework** (–±—ã–ª–æ esp-idf) - —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –¥–ª—è BLE/WiFi
3. ‚úÖ **Passive BLE scan** (`active: false`) - —Å–Ω–∏–∂–µ–Ω–∞ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ WiFi/BT –∞—Ä–±–∏—Ç—Ä
4. ‚úÖ **–£–≤–µ–ª–∏—á–µ–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª BLE** (10s –≤–º–µ—Å—Ç–æ 5s) - –º–µ–Ω—å—à–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
5. ‚úÖ **–£–º–µ–Ω—å—à–µ–Ω–æ –æ–∫–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è** (0.8s –≤–º–µ—Å—Ç–æ 1.1s) - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≤–∏—Å–∞–µ—Ç, —Å—Ç–∞–±–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.

---

### üì® MQTT —É–ª—É—á—à–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ ESP32 –∏–ª–∏ Home Assistant –¥–∞—Ç—á–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ `null` –∏–ª–∏ `0`, —á—Ç–æ –ª–æ–º–∞–ª–æ –≥—Ä–∞—Ñ–∏–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:**
1. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω `retain: true`** –¥–ª—è –≤—Å–µ—Ö MQTT —Ç–æ–ø–∏–∫–æ–≤
   - temperature
   - humidity
   - rssi
   - battery

2. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω `qos: 1`** –¥–ª—è –±–∞—Ç–∞—Ä–µ–∏ (–≥–∞—Ä–∞–Ω—Ç–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏)

3. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `ble_data_received`** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - ESP32 –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω –ø–µ—Ä–≤—ã–π BLE –ø–∞–∫–µ—Ç
   - Mosquitto —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (retain)
   - –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ Home Assistant –≤–∏–¥–∏—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ù–µ—Ç `null` –≤ Home Assistant –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫
- ‚úÖ –ì—Ä–∞—Ñ–∏–∫–∏ –Ω–µ –ª–æ–º–∞—é—Ç—Å—è (–Ω–µ—Ç —Å–∫–∞—á–∫–æ–≤ –∫ 0)
- ‚úÖ –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ ESP32
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ Home Assistant

---

### ‚è±Ô∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á–∞—Å—Ç–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- Temperature: `update_interval: 10s` (–±—ã–ª–æ 5s)
- Humidity: `update_interval: 10s` (–±—ã–ª–æ 5s)
- RSSI: `update_interval: 30s` (–±—ã–ª–æ 5s)
- Battery: `update_interval: 5min` (–±—ã–ª–æ 5s)
- Temperature RAW: `update_interval: 10s` (–±—ã–ª–æ 5s)
- RAW Packet: `update_interval: 10s` (–±—ã–ª–æ 5s)
- Test Counter: `update_interval: 10s` (–±—ã–ª–æ 5s)

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ë–∞—Ç–∞—Ä–µ—è –º–µ–Ω—è–µ—Ç—Å—è –æ—á–µ–Ω—å —Ä–µ–¥–∫–æ - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç
- RSSI –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥
- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ MQTT –∏ Home Assistant

---

### üìã –ò—Ç–æ–≥–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```yaml
esp32:
  board: esp32dev
  framework:
    type: arduino  # –ë—ã–ª–æ: esp-idf

esp32_ble_tracker:
  scan_parameters:
    interval: 10s      # –ë—ã–ª–æ: 5s
    window: 0.8s       # –ë—ã–ª–æ: 1.1s
    active: false      # –ë—ã–ª–æ: true

globals:
  - id: ble_data_received  # –ù–æ–≤—ã–π —Ñ–ª–∞–≥
    type: bool
    initial_value: "false"

# –í lambda –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞:
id(ble_data_received) = true;  # –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞

# –í –∫–∞–∂–¥–æ–º sensor lambda:
if (!id(ble_data_received)) return {};  # –ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

# –í MQTT –ø—É–±–ª–∏–∫–∞—Ü–∏—è—Ö:
retain: true  # –î–æ–±–∞–≤–ª–µ–Ω–æ –≤–µ–∑–¥–µ
qos: 1        # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è battery

# captive_portal - –£–î–ê–õ–Å–ù
```

---

### üéØ –ß—Ç–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ

1. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:**
   - ‚úÖ –ù–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—ã
   - ‚úÖ ESP32 –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ ping
   - ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ BLE/WiFi

2. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:**
   - ‚úÖ Retain —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
   - ‚úÖ QoS 1 –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –¥–æ—Å—Ç–∞–≤–∫—É –±–∞—Ç–∞—Ä–µ–∏
   - ‚úÖ –ù–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

3. **–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö –≤ Home Assistant:**
   - ‚úÖ –ù–µ—Ç `null` –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫
   - ‚úÖ –ì—Ä–∞—Ñ–∏–∫–∏ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤
   - ‚úÖ –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –∑–Ω–∞—á–µ–Ω–∏—è–º–∏

4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
   - ‚úÖ –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ MQTT
   - ‚úÖ –ú–µ–Ω—å—à–µ –∑–∞–ø–∏—Å–µ–π –≤ –±–∞–∑—É HA

---

**–í–µ—Ä—Å–∏—è:** 2.2
**–î–∞—Ç–∞:** 10 –¥–µ–∫–∞–±—Ä—è 2025
**–ê–≤—Ç–æ—Ä:** @andreyorlov
