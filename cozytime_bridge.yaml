esphome:
  name: cozytime-bridge
  includes:
    - cozytime_parser.h

esp32:
  board: esp32dev
  framework:
    type: esp-idf

# Enable logging
logger:
  level: WARN
  logs:
    cozytime: WARN
    esp32_ble_tracker: WARN

# Enable Home Assistant API (УЖЕ БЕЗ password)
api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: "REDACTED_OTA_PASSWORD"

wifi:
  ssid: "REDACTED_WIFI_SSID"
  password: "REDACTED_WIFI_PASSWORD"

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Cozytime Bridge Fallback Hotspot"
    password: "REDACTED_AP_PASSWORD"

globals:
  - id: cozytime_temp
    type: float
    initial_value: "0.0"
  - id: cozytime_temp_raw
    type: int
    initial_value: "0"
  - id: cozytime_humid
    type: float
    initial_value: "0.0"
  - id: cozytime_rssi_value
    type: int8_t
    initial_value: "0"
  - id: cozytime_battery
    type: int
    initial_value: "0"

# ============================================
# BLE СКАНЕР
# ============================================
esp32_ble_tracker:
  scan_parameters:
    interval: 5s       # Сканировать каждые 5 секунд
    window: 1.1s       # Длительность окна сканирования
    active: true
  on_ble_advertise:
    - lambda: |-
        // Парсер CozyTime
        // Проверяем ВСЕ manufacturer data на префикс CECD6CCE

        for (auto &mfg_data : x.get_manufacturer_datas()) {
          const auto& data = mfg_data.data;

          // Проверяем минимальный размер
          if (data.size() < 14) {
            continue;
          }

          // Проверяем фиксированный префикс CECD6CCE (первые 4 байта)
          if (data[0] == 0xCE && data[1] == 0xCD && data[2] == 0x6C && data[3] == 0xCE) {
            // Нашли CozyTime!

            // Переменные данные
            uint8_t temp_byte = data[5];    // byte[5] для температуры
            uint8_t humid_byte = data[7];   // byte[7] для влажности
            uint8_t battery_byte = data[8]; // byte[8] для заряда батареи

            // Вычисляем значения
            // Формула: 1 единица byte[5] = 0.2°F
            float temperature = (temp_byte * 0.2) + 49.7;  // 120*0.2+49.7 = 73.7°F
            float humidity = humid_byte;           // Прямое значение byte[7]
            int battery = battery_byte;            // Прямое значение byte[8]

            id(cozytime_temp) = temperature;
            id(cozytime_temp_raw) = temp_byte;
            id(cozytime_humid) = humidity;
            id(cozytime_battery) = battery;
            id(cozytime_rssi_value) = x.get_rssi();

            return;
          }
        }

sensor:
  # Температура
  - platform: template
    id: cozytime_temperature
    name: "CozyTime Temperature"
    unit_of_measurement: "°F"
    device_class: temperature
    accuracy_decimals: 1
    update_interval: 5s
    lambda: |-
      return id(cozytime_temp);

  # Влажность
  - platform: template
    id: cozytime_humidity
    name: "CozyTime Humidity"
    unit_of_measurement: "%"
    device_class: humidity
    accuracy_decimals: 0
    update_interval: 5s
    lambda: |-
      return id(cozytime_humid);

  # RSSI (уровень сигнала)
  - platform: template
    id: cozytime_rssi
    name: "CozyTime RSSI"
    unit_of_measurement: "dBm"
    icon: "mdi:wifi"
    accuracy_decimals: 0
    update_interval: 5s
    lambda: |-
      return id(cozytime_rssi_value);

  # Заряд батареи
  - platform: template
    id: cozytime_battery_level
    name: "CozyTime Battery"
    unit_of_measurement: "%"
    device_class: battery
    accuracy_decimals: 0
    update_interval: 5s
    lambda: |-
      return id(cozytime_battery);

  # Сырое значение температуры (byte[5])
  - platform: template
    id: cozytime_temperature_raw
    name: "CozyTime Temperature RAW"
    accuracy_decimals: 0
    update_interval: 5s
    lambda: |-
      return id(cozytime_temp_raw);

  - platform: template
    name: "CozyTime Test Counter"
    id: cozytime_test_counter
    unit_of_measurement: "cnt"
    update_interval: 5s
    lambda: |-
      static int value = 0;
      value += 1;
      return value;

captive_portal:
